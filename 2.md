elasticsearch基于json的dsl是必学的，因为即便是java实现也是对json进行了组合。而dsl可以直接验证方案的可行性

![](images/WEBRESOURCEbad5124990054962b0d89f0e416e52b7image.png)

![](images/WEBRESOURCE2ad303763d204565af8c9d1709e65b07image.png)

![](images/WEBRESOURCEfcdc5e95b1f24951b8f580bd1ba0c029image.png)

indexName是elasticsearch中库的name

![](images/WEBRESOURCE333932400d4c49a4a100497aca1e6a00image.png)

对应的业务分析

![](images/WEBRESOURCE31b5a968d56a47f180979a7669d56ec7image.png)

叶子查询

![](images/WEBRESOURCE4c708c5c84874980ba538d65e4951e1dimage.png)

```json
GET /items/_count

GET /items/_search
{
  "query": {
    "match_all": {
     
    }
  }
}

GET /items/_search
{
  "query": {
    "match": {
      "name":"脱脂牛奶"
    }
  }
}
```

![](images/WEBRESOURCEb002ada5142c48939f5bfa756c3339c3image.png)

注意term的value是不会分词的，是精确匹配

```json

GET /items/_search
{
  "query": {
    "term": {
      "category": {
        "value": "牛奶"
      }
    }
  }
}

GET /items/_search
{
  "query": {
    "term": {
      "brand": {
        "value": "飞利浦"
      }
    }
  }
}

GET /items/_search
{
  "query": {
    "range": {
      "price": {
        "gte": 5000
      }
    }
  }
}
```

叶子查询总结

![](images/WEBRESOURCE4fc8adf211c94517b4c8369f1b66ff06image.png)

复合查询

![](images/WEBRESOURCEde914bf6d412483f84a4693a7988ef82image.png)

布尔查询

![](images/WEBRESOURCE7b6b8bceedb3430a8965789b578c46acimage.png)

其中算分时关联度的意思。如果使用filter的搜索就不参与算法。不参与算分是不影响排名前后的，对于name来讲需要算分，但是对于range来讲不需要算分，因为算分会增加处理的时间。

复合查询

需求：搜索"智能手机"，但品牌必须是华为，价格必须是900~1599

```json
GET /items/_search
{
  "query": {
    "bool": {
      "must": [
        {
          "match": {
            "name": "智能手机"
          }
        }
      ],
      "filter": [
        {
          "term": {
            "brand": "华为"
          }
        },
        {
          "range": {
            "price": {
              "gte": 900,
              "lte": 1599
            }
          }
        }
      ]
    }
  }
}
```

一般情况下，我们认为过滤条件如分类、品牌、价格不应该参与算法。而关键字是必须要进行打分的

![](images/WEBRESOURCEac06ea5e547246a7af5196d734e4dd04image.png)

排序和分页

由于name可分词并且建立的是倒排索引，所以无法排序。而其它类型的字段如keyword字段都是可以做排序的

![](images/WEBRESOURCEdc8e946548bc4cb1b5de2d062e9b8dc4image.png)

实现排序功能：

![](images/WEBRESOURCE979999a782c44007be7040d77267b8a0image.png)

实现如下

```json
GET /items/_search
{
  "query": {
    "match_all": {
      
    }
  },
  "sort": [
    {
      "sold": {
        "order": "desc"
      },
      "price": {
        "order": "asc"
      }
    }
  ]
}

POST /items/_update/100000004580
{
  "doc": {
    "sold": 45454
  }
}

```

分页

![](images/WEBRESOURCEa5342afface349bf93d41b41baca446bimage.png)

```json
#from = (page - 1) * size
GET /items/_search
{
  "query": {
    "match_all": {
      
    }
  },
  "sort": [
    {
      "sold": {
        "order": "desc"
      },
      "price": {
        "order": "asc"
      }
    }
  ],
  "from": 2,
  "size": 2
}
```

分页实现案例

![](images/WEBRESOURCE5127ffab811e4a1680ebe155986f01aaimage.png)

```json
GET /items/_search
{
  "query": {
    "match_all": {
      
    }
  },
  "sort": [
    {
      "sold": {
        "order": "desc"
      },
      "price": {
        "order": "asc"
      }
    }
  ],
  "size": 10
}
```

深度分页问题

![](images/WEBRESOURCE82f003b7ca9147c8a62f89cc45bd3377image.png)

深度分页思想：

select * from  where id > 99990 limit 0, 10

![](images/WEBRESOURCEf33466b6c97c4ce080bd03fe49fef545image.png)

高亮显示

![](images/WEBRESOURCE0a0db39199744193a06d2f95ab1bb924image.png)